<!doctype html>
<html>
<head>
<title>Dogflight!</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>

<h1>Dogflight!</h1>

<p>
You control the green plane. Rotate clockwise by having the mouse positioned in the lower region of the playfield or by pressing the "down"-key, counter-clockwise by having the mouse in the upper region or pressing the "up"-key. Positioning the mouse pointer in the central region will stop rotation. Fire by clicking or pressing the space bar.
</p>

<canvas id="flycanvas" width="640" height="480"></canvas>

<div id="scorecontainer">
	<h2>Score</h2>
	<ul id="scores"></ul>
</div>


<audio src="fire.mp3" id="sound0" preload="auto"></audio>

<script src="/socket.io/socket.io.js"></script>
<script src="/jquery.js"></script>
<script src="fly.js"></script>
<script src="fly-client.js"></script>

<script>
var socket = io();
var canvas = $("#flycanvas");
var joined = false;
var player = -1;
var width = -1;
var height = -1;
var renderer = null;

var nick = null;
while(nick == null) {
	nick = window.prompt("Nickname", "Nick");
}

var controlInfo = {
	"d" : 0,
	"f" : false
}

var dir = 0;
canvas.mousemove(function(evt) {
	var mousex = evt.pageX - canvas[0].offsetLeft;
	var mousey = evt.pageY - canvas[0].offsetTop;

	dir = 0;
	if(mousey > canvas[0].height / 2 + 75) {
		dir = 1;
	} else if(mousey < canvas[0].height / 2 - 75) {
		dir = -1;
	}

	sendControl();
});

var fire = false;
canvas.mousedown(function(evt) {
	fire = true;
	sendControl();
	evt.preventDefault();
});
canvas.mouseup(function(evt) {
	fire = false;
	sendControl();
});
canvas.mouseout(function(evt) {
	fire = false;
	sendControl();
});

$(document).keydown(function(evt) {
	switch(evt.which) {
		case 32: // space
			fire = true;
			sendControl();
			break;
		case 38: // up
			dir = -1;
			sendControl();
			break;
		case 40: // down
			dir = 1;
			sendControl();
			break;
		default: return;
	}
	evt.preventDefault();
});

$(document).keyup(function(evt) {
	switch(evt.which) {
		case 32: // space
			fire = false;
			sendControl();
			break;
		case 38: // up
		case 40: // down
			dir = 0;
			sendControl();
			break;
		default: return;
	}
	evt.preventDefault();
});


function sendControl() {
	if(!joined) return;


	if(controlInfo.d != dir || controlInfo.f != fire) {
		controlInfo.d = dir;
		controlInfo.f = fire;
		socket.emit("controlUpdate", controlInfo);
	}
}


socket.on("joinInfo", function(info) {
	console.log(JSON.stringify(info));
	joined = true;
	player = info.player;
	width = info.width;
	height = info.height;

	canvas.attr("width", width);
	canvas.attr("height", height);

	renderer = new FlyRenderer(player, canvas[0]);

});

socket.on("worldUpdate", function(update) {
	if(!joined) return;

	var ctx = canvas[0].getContext("2d");
	renderer.renderBackdrop();
	for(var i = 0; i < update.length; ++i) {
		renderer.renderMsg(update[i]);
	}
	renderer.renderForeground();
});

socket.on("scores", function(update) {
	var list = $("#scores").empty();
	var nicks = update.nicks;
	var scores = update.scores;
	var players = update.players;

	for(var i = 0; i < nicks.length && i < scores.length && i < players.length; ++i) {
		var text = nicks[i] + ": " + scores[i];
		if(player === players[i]) {
			list.append($("<li>").append($("<b>").text(text)));
		} else {
			list.append($("<li>").text(text));
		}
	}
});


socket.emit("join", { "nick": nick });


</script>

</body>
</html>
