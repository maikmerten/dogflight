<!doctype html>
<html>
<head>
<title>Dogflight!</title>
<link rel="stylesheet" href="gh-fork-ribbon.css">
<link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="github-fork-ribbon-wrapper right">
	<div class="github-fork-ribbon">
		<a href="https://github.com/maikmerten/dogflight">Fork me on GitHub</a>
	</div>
</div>

<h1>Dogflight!</h1>

<canvas id="flycanvas" width="640" height="480"></canvas>

<div id="rightcol">
	<h2>Controls</h2>
	<span class="key">&#8592; Left</span>
	<span class="key">&#8594; Right</span>
	<span class="key">&#8593; Boost</span>
	<span class="key">&#8595; Brake</span>
	<br/><br/>
	<span class="key">&nbsp;&nbsp;&nbsp; Space (Fire) &nbsp;&nbsp;&nbsp;</span>

	<h2>Score</h2>
	<ul id="scores"></ul>

</div>



<audio src="fire.mp3" id="sound0" preload="auto"></audio>

<script src="/socket.io/socket.io.js"></script>
<script src="/jquery.js"></script>
<script src="fly-client.js"></script>

<script>
var socket = io();
var canvas = $("#flycanvas");
var joined = false;
var player = -1;
var width = -1;
var height = -1;
var renderer = null;

var nick = null;
while(nick == null) {
	nick = window.prompt("Nickname", "Nick");
}

var controlCmd = 0;

var dir = 0;
canvas.mousemove(function(evt) {
	var mousex = evt.pageX - canvas[0].offsetLeft;
	var mousey = evt.pageY - canvas[0].offsetTop;

	dir = 0;
	if(mousey > canvas[0].height / 2 + 75) {
		dir = 1;
	} else if(mousey < canvas[0].height / 2 - 75) {
		dir = -1;
	}

	sendControl();
});

var fire = false;
var boost = false;
var brake = false;
canvas.mousedown(function(evt) {
	fire = true;
	sendControl();
	evt.preventDefault();
});
canvas.mouseup(function(evt) {
	fire = false;
	sendControl();
});
canvas.mouseout(function(evt) {
	fire = false;
	sendControl();
});

$(document).keydown(function(evt) {
	switch(evt.which) {
		case 32: // space
			fire = true;
			sendControl();
			break;
		case 37: // left
			dir = -1;
			sendControl();
			break;
		case 38: // up
			boost = true;
			sendControl();
			break;
		case 39: // right
			dir = 1;
			sendControl();
			break;
		case 40: // down
			brake = true;
			sendControl();
			break;
		default: return;
	}
	evt.preventDefault();
});

$(document).keyup(function(evt) {
	switch(evt.which) {
		case 32: // space
			fire = false;
			sendControl();
			break;
		case 38:
			boost = false;
			sendControl();
			break;
		case 37: // left
		case 39: // right
			dir = 0;
			sendControl();
			break;
		case 40: // down
			brake = false;
			sendControl();
			break;
		default: return;
	}
	evt.preventDefault();
});


function sendControl() {
	if(!joined) return;

	var cmd = 0;
	if(dir != 0) {
		cmd |= dir < 0 ? 1 : 2;
	}
	cmd |= fire ? 4 : 0;
	cmd |= boost ? 8 : 0;
	cmd |= brake ? 16 : 0;

	if(controlCmd != cmd) {
		socket.emit("ctrl", cmd);
		controlCmd = cmd;
	}
}


socket.on("joinInfo", function(info) {
	console.log(JSON.stringify(info));
	joined = true;
	player = info.player;
	width = info.width;
	height = info.height;

	canvas.attr("width", width);
	canvas.attr("height", height);

	renderer = new FlyRenderer(player, canvas[0]);

});

socket.on("worldUpdate", function(update) {
	if(!joined) return;

	var ctx = canvas[0].getContext("2d");
	renderer.renderBackdrop();
	for(var i = 0; i < update.length; ++i) {
		renderer.renderMsg(update[i]);
	}
	renderer.renderForeground();
});

socket.on("scores", function(update) {
	var list = $("#scores").empty();
	var nicks = update.nicks;
	var scores = update.scores;
	var players = update.players;

	if(renderer == null) {
		return;
	}

	for(var i = 0; i < nicks.length && i < scores.length && i < players.length; ++i) {
		var color = renderer.getPlayerColor(players[i]);
		var text = nicks[i] + ": " + scores[i];
		if(player === players[i]) {
			list.append($("<li>").css("color", color).append($("<b>").text(text)));
		} else {
			list.append($("<li>").css("color", color).text(text));
		}
	}
});


socket.emit("join", { "nick": nick });


</script>

</body>
</html>
